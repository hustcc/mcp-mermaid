name: CI - Lint and Test Coverage

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  lint-and-test:
    name: Lint & Test Coverage
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: npm install

      - name: Run lint check
        run: npm run lint

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage threshold (90%)
        run: |
          node -e "
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-final.json', 'utf8'));
          
          let totalStatements = 0;
          let coveredStatements = 0;
          let totalBranches = 0;
          let coveredBranches = 0;
          let totalFunctions = 0;
          let coveredFunctions = 0;
          let totalLines = 0;
          let coveredLines = 0;

          for (const file in coverage) {
            const fileCoverage = coverage[file];
            
            // Statements
            totalStatements += Object.keys(fileCoverage.s).length;
            coveredStatements += Object.values(fileCoverage.s).filter(v => v > 0).length;
            
            // Branches
            totalBranches += Object.keys(fileCoverage.b).length;
            coveredBranches += Object.values(fileCoverage.b).filter(b => b.some(v => v > 0)).length;
            
            // Functions
            totalFunctions += Object.keys(fileCoverage.f).length;
            coveredFunctions += Object.values(fileCoverage.f).filter(v => v > 0).length;
            
            // Lines (exclude empty lines)
            const lines = fileCoverage.s;
            totalLines += Object.keys(lines).length;
            coveredLines += Object.values(lines).filter(v => v > 0).length;
          }

          const statementsCoverage = (coveredStatements / totalStatements) * 100;
          const branchesCoverage = (coveredBranches / totalBranches) * 100;
          const functionsCoverage = (coveredFunctions / totalFunctions) * 100;
          const linesCoverage = (coveredLines / totalLines) * 100;

          console.log('ðŸ“Š Coverage Report:');
          console.log(\`  Statements: \${statementsCoverage.toFixed(2)}%\`);
          console.log(\`  Branches:   \${branchesCoverage.toFixed(2)}%\`);
          console.log(\`  Functions:  \${functionsCoverage.toFixed(2)}%\`);
          console.log(\`  Lines:      \${linesCoverage.toFixed(2)}%\`);

          const threshold = 90;
          let failed = false;

          if (statementsCoverage < threshold) {
            console.error(\`âŒ Statements coverage (\${statementsCoverage.toFixed(2)}%) is below \${threshold}%\`);
            failed = true;
          }
          if (branchesCoverage < threshold) {
            console.error(\`âŒ Branches coverage (\${branchesCoverage.toFixed(2)}%) is below \${threshold}%\`);
            failed = true;
          }
          if (functionsCoverage < threshold) {
            console.error(\`âŒ Functions coverage (\${functionsCoverage.toFixed(2)}%) is below \${threshold}%\`);
            failed = true;
          }
          if (linesCoverage < threshold) {
            console.error(\`âŒ Lines coverage (\${linesCoverage.toFixed(2)}%) is below \${threshold}%\`);
            failed = true;
          }

          if (failed) {
            console.error(\`\\nâŒ Coverage check failed. Minimum required: \${threshold}%\`);
            process.exit(1);
          }

          console.log(\`\\nâœ… All coverage metrics meet the \${threshold}% threshold!\`);
          "

      - name: Upload coverage to Codecov (if token exists)
        if: matrix.node-version == '20.x'
        continue-on-error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          if [ -z "$CODECOV_TOKEN" ]; then
            echo "Skipping Codecov upload - no token configured"
            exit 0
          fi
          echo "Uploading coverage to Codecov..."
          npx codecov-cli upload-process --file ./coverage/lcov.info --fail-on-error false || true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: matrix.node-version == '20.x'
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: build/
          retention-days: 7

